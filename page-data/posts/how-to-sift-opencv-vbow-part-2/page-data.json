{"componentChunkName":"component---src-pages-posts-markdown-remark-frontmatter-slug-tsx","path":"/posts/how-to-sift-opencv-vbow-part-2/","result":{"data":{"markdownRemark":{"html":"<h1>Image Classification in Python with Visual Bag of Words (VBoW)</h1>\n<p><a href=\"../how-to-sift-opencv-vbow-part-1\">Part 1</a></p>\n<p><a href=\"../how-to-sift-opencv-vbow-part-2\">Part 2</a></p>\n<h2>Part 2: The Visual Bag of Words Model</h2>\n<h3>What is a Bag of Words?</h3>\n<p>In the world of natural language processing (NLP), we often want to compare multiple documents. Documents each have a bunch of different words in a certain order. We will ignore the order and just throw the words into a bag. Then we can simply count the occurences of each word in the corpus of all words. Finally, each document is converted to a histogram of word counts, and that can be used as features for machine learning.</p>\n<p>We make our corpus of all words from taking the set of all the words in the all documents within our training set. The test set documents can have words that don't show up in the corpus -- those words will just be ignored. We have to do this because in order to feed data into a machine learning classifier, each observation must have the same number of features: we can't have one document with 100 features and another with 104 features.</p>\n<h3>Non-standard words?</h3>\n<p>On many documents we can do an exact match for words, because modern English spelling is pretty standardized. We always spell <code>herself</code> as <code>herself</code>. But if we take some Middle English from Chaucer's Canturbury Tales, we will find that <code>herself</code> is spelled <a href='http://sites.fas.harvard.edu/~chaucer/spelling.htm'>many ways:</a> hire-self, herself, herselven, hireself, hireselve, hireselven, hirself, hirselve, hirselven, hirsilf, hyreself, and hyrself.</p>\n<p><em>Excerpt:</em></p>\n<blockquote>\n<p>The coper teyne, noght knowing this preest,<br>\nAnd hidde it, and him hente by the breest,<br>\nAnd to him spak, and thus seyde in his game,<br>\n'Stoupeth adoun, by god, ye be to blame,<br>\nHelpeth me now, as I dide yow whyl-er,<br>\nPutte in your hand, and loketh what is ther.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/887d75b199edba889bbba72b2e2ff805/c08c5/canterbury.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMB/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAEDBP/aAAwDAQACEAMQAAAByhntYI//xAAZEAEAAgMAAAAAAAAAAAAAAAABAAIDERL/2gAIAQEAAQUCVtmpsnc//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAQUBAAAAAAAAAAAAAAAAAAECITFBUf/aAAgBAQAGPwJ3Fokw/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAERIWGRof/aAAgBAQABPyFpQ4pdlF2fB4aH/9oADAMBAAIAAwAAABB3/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAAAAf/aAAgBAwEBPxCo/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERQf/aAAgBAgEBPxDIRH//xAAcEAEAAgIDAQAAAAAAAAAAAAABESEAkTFBYYH/2gAIAQEAAT8Qr50BIQ6217l9MvCzpiTb/Of/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Illuminated manuscript\"\n        title=\"\"\n        src=\"/static/887d75b199edba889bbba72b2e2ff805/1c72d/canterbury.jpg\"\n        srcset=\"/static/887d75b199edba889bbba72b2e2ff805/a80bd/canterbury.jpg 148w,\n/static/887d75b199edba889bbba72b2e2ff805/1c91a/canterbury.jpg 295w,\n/static/887d75b199edba889bbba72b2e2ff805/1c72d/canterbury.jpg 590w,\n/static/887d75b199edba889bbba72b2e2ff805/c08c5/canterbury.jpg 640w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>If we have a bunch of documents in Middle English and make a histogram of the whole corpus, we'll count <code>hirselve</code>, <code>hirsilf</code>, and <code>hyreself</code> as totally different words. It will be hard to figure out which documents are talking about women. Because spelling variation is such a big issue, we need some way to <strong>cluster</strong> all the variants of a word together so that they wind up in the same bin.</p>\n<h3>\"Visual words\"</h3>\n<p>In the <a href=\"../how-to-sift-opencv-vbow-part-1\">previous post</a> I explained what SIFT descriptors are and how to generate them. If we think of every picture as a document of SIFT \"words\", we can extend the bag of words model to classify images instead of text documents. We might imagine that one SIFT descriptor \"visual word\" represents an octopus eye, another one represents a tentacle \"suction cup\", and so on.</p>\n<p>These visual words have spelling variations, just like Middle English, so we have to have some clustering method to bin together the words that represent the same thing. All the eye features should go to the same bin, all the tentacle suckers in their own bin. It's more intuitive to think of the bins as being <strong>codewords</strong> like \"eye features\" and \"tentacle features\".</p>\n<p>However, SIFT features are not so literal as \"octopus eye\", they tend to represent something more like \"bright blob which gradually blends into darkish blob with a diagonal oblong midtone blob\". We can't bin them together based on some human-meaningful definition. But we can bin them together mathematically. SIFT descriptors are 128-dimensional vectors, so we can simply make a matrix with every SIFT descriptor in our training set as its own row, and 128 columns for each of the dimensions of the SIFT features. Plug that matrix to a clustering algorithm like KMeans, then get the descriptors clustered into K different codewords (ie, K different clusters, or K different bins).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e49e1758d181dc061fcb75b3a25c4f7/a2510/octo_vbow_bag.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIFBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAFLeCjDih//xAAbEAEAAgIDAAAAAAAAAAAAAAABAAIRIRITFP/aAAgBAQABBQK1nvXRYmH0Nd8Cf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/AWf/xAAcEAABAwUAAAAAAAAAAAAAAAARABBRARIiMTL/2gAIAQEABj8CvFOpUsDidBEt/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAERIUExof/aAAgBAQABPyGW5pRvwZZLHBjVVD4/xCgjUJeH/9oADAMBAAIAAwAAABD0P//EABURAQEAAAAAAAAAAAAAAAAAAAAh/9oACAEDAQE/EEf/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/EKawVP/EAB0QAQEAAgIDAQAAAAAAAAAAAAERACExUUGR4fD/2gAIAQEAAT8QeIg9jY0Xp9xItaIu5fWAJuVF84ggKXZY4uMCVcd/pgXEu9Ez/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bag of visual words diagram\"\n        title=\"\"\n        src=\"/static/5e49e1758d181dc061fcb75b3a25c4f7/1c72d/octo_vbow_bag.jpg\"\n        srcset=\"/static/5e49e1758d181dc061fcb75b3a25c4f7/a80bd/octo_vbow_bag.jpg 148w,\n/static/5e49e1758d181dc061fcb75b3a25c4f7/1c91a/octo_vbow_bag.jpg 295w,\n/static/5e49e1758d181dc061fcb75b3a25c4f7/1c72d/octo_vbow_bag.jpg 590w,\n/static/5e49e1758d181dc061fcb75b3a25c4f7/a8a14/octo_vbow_bag.jpg 885w,\n/static/5e49e1758d181dc061fcb75b3a25c4f7/a2510/octo_vbow_bag.jpg 1000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Next we go through each individual image, and assign all of its SIFT descriptors to the bin they belong in. All the \"eye\" SIFT descriptors will be converted from a 128-dimensional SIFT vector to a bin label like \"eye\" or \"Bin number 4\". Finally we make a histogram for each image by summing the number of features for each codeword. For example, with K=3, we might get a total of 1 eye feature, 3 tentacle features, and 5 tentacle sucker features for image number 1; a different distribution for image number 2, and so on. (Remember, this is just a metaphor: real SIFT feature clusters won't have such a human-meaningful definition.)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/12bf94a76bc07152a07fd33f88f8173c/b54c8/octo_histogram.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABXpaqCFRP/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAAwQxQf/aAAgBAQABBQJrrAaXc46To1P/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwFn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHBAAAQQDAQAAAAAAAAAAAAAAAQACITEgIiNx/9oACAEBAAY/AndTdIE7OmU73D//xAAaEAACAgMAAAAAAAAAAAAAAAABEQAhEEGR/9oACAEBAAE/Ib3CCSCocKguozYvWHI//9oADAMBAAIAAwAAABD0H//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8Q0oJQ/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRAAAgIBBQAAAAAAAAAAAAAAAREAITEQQWGBsf/aAAgBAQABPxAmkREiMra4I2RwQikGOPJemBrFoIVM3cxaf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bag of visual words histogram\"\n        title=\"\"\n        src=\"/static/12bf94a76bc07152a07fd33f88f8173c/1c72d/octo_histogram.jpg\"\n        srcset=\"/static/12bf94a76bc07152a07fd33f88f8173c/a80bd/octo_histogram.jpg 148w,\n/static/12bf94a76bc07152a07fd33f88f8173c/1c91a/octo_histogram.jpg 295w,\n/static/12bf94a76bc07152a07fd33f88f8173c/1c72d/octo_histogram.jpg 590w,\n/static/12bf94a76bc07152a07fd33f88f8173c/b54c8/octo_histogram.jpg 879w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div style='text-align: center;'>Image 1 --> <code>[1, 3, 5]</code></div>\n<p>At this point we have converted images with varying numbers of SIFT features into K features. We can feed the matrix of M observations and K features into a classifier like AdaBoost or SVC as our <code>X</code>, image labels as our <code>y</code>, and it ought to be able to predict image labels from images with some degree of accuracy.</p>\n<h3>But what is K? How many bins do we need?</h3>\n<p>For my panda detector project I performed a <strong>grid search</strong> across a range of K values and compared the scores of classifiers for each K. My grid search code is <a href=\"https://github.com/IanLondon/general_img_classifier/blob/master/K_grid_search.py\">on GitHub</a> and references other files in <a href=\"https://github.com/IanLondon/general_img_classifier\">the repo</a>.</p>\n<p>Determining what K to use for K-means <a href=\"https://en.wikipedia.org/wiki/Determining_the_number_of_clusters_in_a_data_set\">is an art, not a science</a>, so depending on your project (and how long it takes to do a grid search) you might want to try different methods.</p>","frontmatter":{"date":"May 11, 2016","slug":"how-to-sift-opencv-vbow-part-2","title":"VBoW Pt 2 - Image Classification in Python with Visual Bag of Words (VBoW)","splashImage":null}}},"pageContext":{"id":"4c57f941-1851-5bae-ae0c-f722665a61cc","frontmatter__slug":"how-to-sift-opencv-vbow-part-2","__params":{"frontmatter__slug":"how-to-sift-opencv-vbow-part-2"}}},"staticQueryHashes":[],"slicesMap":{}}